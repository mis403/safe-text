# Safe-Text 项目启动指南

## 🚀 快速启动 (推荐)

### 方法1: 使用启动脚本 (最简单)
```bash
# 进入项目目录
cd /Users/ws/Developer/safe-text

# 直接运行启动脚本
./start_multiprocess.sh
```

### 方法2: 手动启动命令
```bash
# 进入项目目录
cd /Users/ws/Developer/safe-text

# 启动4个工作进程的API服务
/Users/ws/Library/Python/3.9/bin/gunicorn -c gunicorn_config.py api_server:app
```

### 方法3: 单进程开发模式
```bash
# 进入项目目录
cd /Users/ws/Developer/safe-text

# 开发调试模式 (单进程)
python3 api_server.py --port 9900 --debug
```

## 📋 启动前检查清单

### 1. 环境依赖检查
```bash
# 检查Python版本
python3 --version

# 检查依赖包
pip3 list | grep -E "(flask|gunicorn|torch|transformers)"
```

### 2. 模型文件检查
```bash
# 检查是否有训练好的模型
ls -la outputs/training_*/final_model/
```

### 3. 配置文件检查
```bash
# 检查配置文件
cat config/training.yaml
cat gunicorn_config.py
```

## 🔧 启动过程详解

### 启动流程
1. **Master进程启动** - 负责管理和负载均衡
2. **创建4个Worker进程** - 每个进程独立运行
3. **每个Worker加载模型** - 独立的XLM-RoBERTa实例
4. **开始接收请求** - 自动分发到空闲进程

### 启动日志示例
```
🚀 启动Safe-Text多进程API服务...
🔧 使用4个工作进程启动服务...

INFO:api_server:🔍 进程 7307: 查找最新训练的模型...
INFO:api_server:🤖 进程 7307: 加载模型 outputs/training_xxx/final_model
INFO:api_server:✅ 进程 7307: 推理引擎初始化成功

INFO:api_server:🔍 进程 7308: 查找最新训练的模型...
INFO:api_server:🤖 进程 7308: 加载模型 outputs/training_xxx/final_model
INFO:api_server:✅ 进程 7308: 推理引擎初始化成功

... (4个进程都会显示类似日志)
```

## 🌐 服务器部署

### 生产环境启动
```bash
# 1. 上传项目到服务器
scp -r safe-text/ user@server:/path/to/

# 2. 服务器上安装依赖
cd /path/to/safe-text
pip3 install -r requirements.txt

# 3. 启动服务 (后台运行)
nohup ./start_multiprocess.sh > server.log 2>&1 &

# 4. 检查服务状态
curl -H "Authorization: Bearer safe-text-api-2025-9d8f7e6c5b4a3210" http://localhost:9900/health
```

### Docker部署 (可选)
```dockerfile
# Dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY . .

RUN pip install -r requirements.txt

EXPOSE 9900

CMD ["./start_multiprocess.sh"]
```

```bash
# 构建和运行
docker build -t safe-text .
docker run -p 9900:9900 safe-text
```

## 🔍 服务验证

### 1. 健康检查
```bash
curl -H "Authorization: Bearer safe-text-api-2025-9d8f7e6c5b4a3210" \
     http://localhost:9900/health
```

### 2. 测试预测接口
```bash
curl -X POST \
     -H "Authorization: Bearer safe-text-api-2025-9d8f7e6c5b4a3210" \
     -H "Content-Type: application/json" \
     -d '{"text":"这是一个测试文本"}' \
     http://localhost:9900/predict
```

### 3. 检查进程状态
```bash
# 查看gunicorn进程
ps aux | grep gunicorn

# 查看端口占用
lsof -i :9900
```

## ⚙️ 配置说明

### gunicorn_config.py 关键配置
```python
workers = 4                    # 工作进程数 (4个模型实例)
worker_connections = 8         # 每进程连接数
bind = "0.0.0.0:9900"         # 绑定地址和端口
timeout = 120                  # 请求超时时间
```

### 性能调优建议
- **CPU密集**: workers = CPU核心数
- **内存充足**: 可增加到6-8个workers
- **显存限制**: 保持4个workers (每个~600MB)

## 🛑 停止服务

### 方法1: 使用PID文件
```bash
# 优雅停止
kill -TERM `cat /tmp/gunicorn_safe_text.pid`

# 强制停止
kill -KILL `cat /tmp/gunicorn_safe_text.pid`
```

### 方法2: 查找进程停止
```bash
# 查找主进程
ps aux | grep gunicorn | grep master

# 停止主进程 (会自动停止所有worker)
kill -TERM <master_pid>
```

## 🚨 常见问题

### Q1: 启动失败 "gunicorn: command not found"
```bash
# 解决方案: 使用完整路径
/Users/ws/Library/Python/3.9/bin/gunicorn -c gunicorn_config.py api_server:app
```

### Q2: 模型加载失败
```bash
# 检查模型文件
ls -la outputs/training_*/final_model/config.json

# 重新训练模型
python3 train.py
```

### Q3: 端口被占用
```bash
# 查看端口占用
lsof -i :9900

# 杀死占用进程
kill -9 <pid>
```

### Q4: 权限问题
```bash
# 给启动脚本执行权限
chmod +x start_multiprocess.sh

# 检查日志目录权限
mkdir -p logs
chmod 755 logs
```

## 📊 监控和日志

### 日志文件位置
- **应用日志**: `logs/app.log`
- **Gunicorn访问日志**: `logs/gunicorn_access.log`
- **Gunicorn错误日志**: `logs/gunicorn_error.log`

### 实时监控
```bash
# 查看实时日志
tail -f logs/gunicorn_error.log

# 查看进程资源使用
top -p `pgrep -f gunicorn`
```

---

## 🎯 总结

**最简单的启动方式**:
```bash
cd /Users/ws/Developer/safe-text
./start_multiprocess.sh
```

**验证服务**:
```bash
curl -H "Authorization: Bearer safe-text-api-2025-9d8f7e6c5b4a3210" http://localhost:9900/health
```

**🚀 启动成功后，您就拥有了4个模型实例的高性能API服务！**
